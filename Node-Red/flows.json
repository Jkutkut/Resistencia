[{"id":"b081fd91.ebbbd","type":"tab","label":"Page Manager","disabled":false,"info":""},{"id":"3ee4a50f.d7fd0a","type":"tab","label":"Add to DataBase","disabled":false,"info":""},{"id":"ae5a.fbf7e1a608","type":"tab","label":"Get from Database","disabled":false,"info":""},{"id":"f3948f39.2753c","type":"tab","label":"FSM","disabled":false,"info":""},{"id":"a5762d7.f21efd","type":"sqlitedb","db":":memory:","mode":"RWC"},{"id":"eb6070eb.b7eda","type":"http in","z":"b081fd91.ebbbd","name":"","url":"/waitingRoom:extra","method":"get","upload":false,"swaggerDoc":"","x":150,"y":140,"wires":[["c036542c.d78418"]]},{"id":"785d8381.488e5c","type":"http response","z":"b081fd91.ebbbd","name":"","x":1110,"y":280,"wires":[]},{"id":"f99d6b51.a39928","type":"http in","z":"b081fd91.ebbbd","name":"","url":"/mainMenu:extra","method":"get","upload":false,"swaggerDoc":"","x":140,"y":220,"wires":[["b726ee89.6e5b4"]]},{"id":"c7223621.2198a8","type":"http in","z":"b081fd91.ebbbd","name":"","url":"/rootMenu","method":"get","upload":false,"swaggerDoc":"","x":120,"y":180,"wires":[["edde527e.445e8"]]},{"id":"d1e60e43.00faf","type":"http in","z":"b081fd91.ebbbd","name":"","url":"/createPlayer","method":"get","upload":false,"swaggerDoc":"","x":130,"y":97,"wires":[["69c3e7eb.021098"]]},{"id":"a4a57b89.9935f8","type":"debug","z":"b081fd91.ebbbd","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":530,"y":700,"wires":[]},{"id":"5a5de0b8.bc347","type":"http in","z":"b081fd91.ebbbd","name":"","url":"/Res/:type/:content","method":"get","upload":false,"swaggerDoc":"","x":141,"y":657,"wires":[["31277ac5.bd2f06"]]},{"id":"ebd5aa2a.6ec738","type":"http in","z":"b081fd91.ebbbd","name":"","url":"/Res/:type/:subtype/:content","method":"get","upload":false,"swaggerDoc":"","x":171,"y":697,"wires":[["31277ac5.bd2f06"]]},{"id":"c63e6c67.03d1","type":"http response","z":"b081fd91.ebbbd","name":"","x":710,"y":740,"wires":[]},{"id":"d1e00c12.cf8e7","type":"catch","z":"b081fd91.ebbbd","name":"","scope":null,"uncaught":true,"x":120,"y":740,"wires":[["982e7120.4806f"]]},{"id":"982e7120.4806f","type":"function","z":"b081fd91.ebbbd","name":"Set 404","func":"msg.payload = msg.error;\nmsg.statusCode = 404;//resource not found\nnode.warn(\"ERROR\");\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":300,"y":740,"wires":[["c63e6c67.03d1","a4a57b89.9935f8"]]},{"id":"cb7e0905.952388","type":"file in","z":"b081fd91.ebbbd","name":"","filename":"","format":"","chunk":false,"sendError":false,"encoding":"none","x":550,"y":651,"wires":[["c63e6c67.03d1","1e8ebb5e.eec3a5"]]},{"id":"31277ac5.bd2f06","type":"function","z":"b081fd91.ebbbd","name":"","func":"let basicURL = global.get(\"DIR\") + global.get(\"RES\");\n\nlet content = msg.req.params.type + \"/\";\nif (msg.req.params.subtype) {\n    content += msg.req.params.subtype + \"/\";\n}\ncontent += msg.req.params.content;\n\nif (content.includes(\"..\")) {\n    msg.payload = \"Illegal file path\";\n    msg.statusCode = 405;//not allowed\n    return [null, msg];//fire output 2\n}\n\nmsg.filename = basicURL + content;\n\nmsg.headers = {};\n\nif (/\\.png$/.test(content)) {\n    msg.headers[\"content-type\"] = \"image/png\";\n}\nelse if (/\\.jpeg$/.test(content)) {\n    msg.headers[\"content-type\"] = \"image/jpeg\";\n}\n\n\nreturn [msg, null];","outputs":2,"noerr":0,"initialize":"","finalize":"","libs":[],"x":399,"y":657,"wires":[["cb7e0905.952388"],["a4a57b89.9935f8"]]},{"id":"e024e963.c4ad88","type":"http in","z":"3ee4a50f.d7fd0a","name":"","url":"/createPlayer.php","method":"post","upload":false,"swaggerDoc":"","x":140,"y":400,"wires":[["991c8d.2321337"]]},{"id":"e60b12c1.93bb3","type":"inject","z":"3ee4a50f.d7fd0a","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":true,"onceDelay":"0","topic":"","payload":"Started!","payloadType":"str","x":126,"y":58,"wires":[["c749d650.a0bfb8"]]},{"id":"4fec79f9.70e158","type":"inject","z":"3ee4a50f.d7fd0a","name":"","props":[],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payloadType":"str","x":130,"y":1280,"wires":[["3238142f.bab64c"]]},{"id":"d0a7d8c3.560628","type":"http in","z":"3ee4a50f.d7fd0a","name":"","url":"/addImg.php","method":"post","upload":true,"swaggerDoc":"","x":130,"y":600,"wires":[["574b5b49.2f9954","5a8eed85.5df174"]]},{"id":"b482030f.21609","type":"template","z":"3ee4a50f.d7fd0a","name":"","field":"topic","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"INSERT INTO Players ('name') values (\"{{user}}\");","output":"str","x":600,"y":400,"wires":[["32422764.0b24c8"]]},{"id":"aea19364.428f5","type":"debug","z":"3ee4a50f.d7fd0a","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"user","targetType":"msg","statusVal":"","statusType":"auto","x":560,"y":340,"wires":[]},{"id":"aeccccbe.c3651","type":"template","z":"3ee4a50f.d7fd0a","name":"","field":"topic","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"SELECT pId FROM Players WHERE name = '{{user}}'","output":"str","x":600,"y":440,"wires":[["171f5cd2.8a69c3"]]},{"id":"991c8d.2321337","type":"change","z":"3ee4a50f.d7fd0a","name":"Save UserName as msg.user","rules":[{"t":"set","p":"user","pt":"msg","to":"payload.name","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":380,"y":400,"wires":[["aea19364.428f5","b482030f.21609"]]},{"id":"22d63c4a.f482f4","type":"debug","z":"3ee4a50f.d7fd0a","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":550,"y":1400,"wires":[]},{"id":"89c682dc.10d91","type":"inject","z":"3ee4a50f.d7fd0a","name":"","props":[],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","x":130,"y":1340,"wires":[["c6dd8369.83d07"]]},{"id":"75fcac30.a40d84","type":"inject","z":"3ee4a50f.d7fd0a","name":"","props":[],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","x":130,"y":1400,"wires":[["ef757fa9.1b623"]]},{"id":"f47c840c.f85e88","type":"template","z":"3ee4a50f.d7fd0a","name":"Create response for user device","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"Img stored and linked","output":"str","x":810,"y":660,"wires":[["6a7be78a.149938"]]},{"id":"6a7be78a.149938","type":"http response","z":"3ee4a50f.d7fd0a","name":"Send response","statusCode":"","headers":{},"x":1400,"y":660,"wires":[]},{"id":"4ca8aeee.b889f","type":"http in","z":"3ee4a50f.d7fd0a","name":"","url":"/changeOpinion.php","method":"post","upload":false,"swaggerDoc":"","x":150,"y":1060,"wires":[["38549207.1bddae"]]},{"id":"356bab9a.e79fe4","type":"template","z":"3ee4a50f.d7fd0a","name":"Create response for user device","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"Succeed","output":"str","x":1090,"y":971,"wires":[["6a7be78a.149938"]]},{"id":"48a892ea.b7576c","type":"debug","z":"ae5a.fbf7e1a608","name":"","active":true,"console":"false","complete":"false","x":2365,"y":591,"wires":[]},{"id":"7e6df6c0.483488","type":"debug","z":"ae5a.fbf7e1a608","name":"","active":true,"console":"false","complete":"false","x":2365,"y":631,"wires":[]},{"id":"a16b49f6.4c2698","type":"file","z":"3ee4a50f.d7fd0a","name":"","filename":"","appendNewline":true,"createDir":true,"overwriteFile":"true","encoding":"none","x":610,"y":660,"wires":[["f47c840c.f85e88"]]},{"id":"56cae460.d8aa9c","type":"change","z":"3ee4a50f.d7fd0a","name":"Get img","rules":[{"t":"set","p":"payload","pt":"msg","to":"img","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":460,"y":660,"wires":[["a16b49f6.4c2698","c7e93643.f35868"]]},{"id":"4d4c089.b361bf8","type":"http in","z":"ae5a.fbf7e1a608","name":"","url":"/getImg.php","method":"get","upload":true,"swaggerDoc":"","x":120,"y":120,"wires":[["ee89c25a.03cd8"]]},{"id":"c6a4487f.dd6868","type":"debug","z":"ae5a.fbf7e1a608","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":530,"y":60,"wires":[]},{"id":"ee89c25a.03cd8","type":"change","z":"ae5a.fbf7e1a608","name":"Save UserName as msg.user","rules":[{"t":"set","p":"user","pt":"msg","to":"payload.name","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":340,"y":120,"wires":[["c6a4487f.dd6868","92d34976.6adba8"]]},{"id":"92d34976.6adba8","type":"template","z":"ae5a.fbf7e1a608","name":"","field":"topic","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"SELECT pId from Players WHERE name = '{{user}}';","output":"str","x":540,"y":120,"wires":[["a93829ab.1c00e8","2c1b2c8c.b8e8f4"]]},{"id":"c0d1b3f6.b4cc3","type":"change","z":"ae5a.fbf7e1a608","name":"Save pId","rules":[{"t":"set","p":"pId","pt":"msg","to":"payload[0].pId","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":820,"y":120,"wires":[["247a848f.b3b08c"]]},{"id":"2c1b2c8c.b8e8f4","type":"debug","z":"ae5a.fbf7e1a608","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"topic","targetType":"msg","statusVal":"","statusType":"auto","x":700,"y":60,"wires":[]},{"id":"247a848f.b3b08c","type":"function","z":"ae5a.fbf7e1a608","name":"get filename","func":"msg.filename = \"/tmp/userIcons/userIcon\" + msg.user + msg.pId + \".png\";\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":970,"y":120,"wires":[["c0071a2c.504f48"]]},{"id":"c0071a2c.504f48","type":"file in","z":"ae5a.fbf7e1a608","name":"","filename":"","format":"utf8","chunk":false,"sendError":false,"encoding":"none","x":1120,"y":120,"wires":[["f8d56b3b.3bb1f8","94959a30.cae2d8"]]},{"id":"4e1d8a2c.17e6e4","type":"http in","z":"ae5a.fbf7e1a608","name":"","url":"/players","method":"get","upload":true,"swaggerDoc":"","x":110,"y":180,"wires":[["1417bd61.8d01d3"]]},{"id":"499e8414.30635c","type":"inject","z":"f3948f39.2753c","name":"Started","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":true,"onceDelay":"0","topic":"init of FSM","payload":"","payloadType":"date","x":120,"y":60,"wires":[["c90835f5.3765d8"]]},{"id":"da5dcf03.c4bc5","type":"debug","z":"f3948f39.2753c","name":"FSM created","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"topic","targetType":"msg","statusVal":"","statusType":"auto","x":440,"y":60,"wires":[]},{"id":"c90835f5.3765d8","type":"function","z":"f3948f39.2753c","name":"INIT FSM","func":"const STATES = {\n    SETUP: 0,\n    ROUND: 1,\n    MISSION: 2,\n    END: 3,\n    0: \"Setup\",\n    1: \"Round\",\n    2: \"Mission\",\n    3: \"End\"\n}\n\nglobal.set(\"currentState\", STATES.SETUP);\nglobal.set(\"STATES\", STATES);\n\nmsg.topic = \"FSM initialized\";\n\n\nglobal.set(\"missionFailedTimes\", 0); // Times consecutively the mission poll has failed\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":270,"y":60,"wires":[["da5dcf03.c4bc5"]]},{"id":"23b59e28.955ff2","type":"http in","z":"f3948f39.2753c","name":"","url":"/startGame","method":"post","upload":false,"swaggerDoc":"","x":120,"y":240,"wires":[["7d08bb9d.4b56b4","a5c3989f.652b18"]]},{"id":"7d08bb9d.4b56b4","type":"function","z":"f3948f39.2753c","name":"Change State if valid","func":"let STATES = global.get(\"STATES\");\n\nlet state = global.get(\"currentState\");\n\nif (state != STATES.SETUP) {\n    throw \"Can not start the game, the current state is not valid (\" + STATES[state] + \")\"; \n}\nelse {\n    node.warn(\"Changing to meetup\");\n    global.set(\"currentState\", STATES.ROUND);\n}\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":320,"y":240,"wires":[["ff3949b9.b3e1f8"]]},{"id":"1cf5b11e.1604df","type":"catch","z":"f3948f39.2753c","name":"","scope":null,"uncaught":false,"x":740,"y":60,"wires":[["ab2338b1.ba7a08","28018874.84f118"]]},{"id":"ab2338b1.ba7a08","type":"debug","z":"f3948f39.2753c","name":"","active":true,"tosidebar":true,"console":true,"tostatus":false,"complete":"error","targetType":"msg","statusVal":"","statusType":"auto","x":910,"y":100,"wires":[]},{"id":"9a1b58b.4e288a8","type":"function","z":"3ee4a50f.d7fd0a","name":"update topic (debug msg)","func":"msg.topic = \"Database created\";\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1010,"y":100,"wires":[["aabe3c03.c99b6"]]},{"id":"aabe3c03.c99b6","type":"debug","z":"3ee4a50f.d7fd0a","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"topic","targetType":"msg","statusVal":"","statusType":"auto","x":1240,"y":120,"wires":[]},{"id":"ae435d20.e9fab","type":"inject","z":"f3948f39.2753c","name":"debug CurrentPhase","props":[],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","x":156,"y":140,"wires":[["1aa8eae.9bdb515"]]},{"id":"1aa8eae.9bdb515","type":"function","z":"f3948f39.2753c","name":"Get currentState","func":"const STATES = global.get(\"STATES\");\nlet state = global.get(\"currentState\");\n\nmsg.payload = \"Current state is: \" + STATES[state];\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":346,"y":140,"wires":[["dbad9e44.0185c"]]},{"id":"dbad9e44.0185c","type":"debug","z":"f3948f39.2753c","name":"log debug","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":546,"y":140,"wires":[]},{"id":"525035de.1f9f0c","type":"switch","z":"f3948f39.2753c","name":"Check FSM","property":"currentState","propertyType":"global","rules":[{"t":"eq","v":"STATES.SETUP","vt":"global"},{"t":"eq","v":"STATES.ROUND","vt":"global"},{"t":"eq","v":"STATES.MISSION","vt":"global"},{"t":"eq","v":"STATES.END","vt":"global"}],"checkall":"false","repair":false,"outputs":4,"x":584,"y":974,"wires":[["7ea6e723.6355f8"],["c167329f.3f94b"],["7e07dab8.9dc3e4"],["3a8e7726.d98b68"]]},{"id":"a53863af.9150a","type":"http response","z":"f3948f39.2753c","name":"","x":1050,"y":1000,"wires":[]},{"id":"26e9f1a1.15eeee","type":"http in","z":"f3948f39.2753c","name":"","url":"/canStopWaiting","method":"get","upload":false,"swaggerDoc":"","x":140,"y":980,"wires":[["bd4f8fa4.971b6"]]},{"id":"c167329f.3f94b","type":"function","z":"f3948f39.2753c","name":"Go to meetup and MainMenu","func":"let s = parseInt(msg.payload.currentState);\nlet STATES = global.get(\"STATES\");\n\nif (s == STATES.SETUP) { // If firstTime\n    msg.payload = \"meetup.html\";    \n}\nelse {\n    msg.payload = \"mainMenu.html\";\n}\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":840,"y":960,"wires":[["a53863af.9150a"]]},{"id":"35365ffa.47cb7","type":"inject","z":"ae5a.fbf7e1a608","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":820,"y":160,"wires":[["6bab2eae.5c311"]]},{"id":"6bab2eae.5c311","type":"function","z":"ae5a.fbf7e1a608","name":"get filename","func":"msg.filename = \"/tmp/userIcons/userIcondbs27.png\";\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":970,"y":160,"wires":[["c0071a2c.504f48"]]},{"id":"a9ebdb1f.09dd18","type":"function","z":"f3948f39.2753c","name":"Select the chunguitos","func":"/**\n * Retuns the number of enemies in the game\n * @param (number) n - Number of players\n */\nlet chunguitosF = function(n) {\n    switch(n) {\n        case 5:\n        case 6:\n            return 2;\n        case 7:\n        case 8:\n        case 9:\n            return 3;\n        case 10:\n            return 4;\n        default:\n            throw \"The number of players is not valid\";\n    }\n}\n\nlet players = msg.payload; // Array of players\nlet chunguitos = chunguitosF(players.length); // number of chunguitos\nmsg.chunguitos = []; // All the chunguitos pIds will be stored here\n\nlet indices = [];\nwhile (indices.length < chunguitos) {\n    let alreadyIn = false;\n    let newRandom = Math.floor(Math.random() * players.length); // Not +1 because this will be used for array indexing\n    for (let i of indices) {\n        if (i == newRandom) {\n            alreadyIn = true;\n            break;\n        }\n    }\n    if (!alreadyIn) {\n        indices.push(newRandom);\n        try {\n            \n            msg.chunguitos.push(players[newRandom].pId);\n        }\n        catch(e) {\n            node.warn(\"ERROR on pId: index = \" + newRandom);\n            throw e;\n        }\n    }\n}\n\nglobal.set(\"chunguitos\", msg.chunguitos);\n\nmsg.chunguitosIndex = 0;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":400,"y":296,"wires":[["4ad9850b.01bf6c"]]},{"id":"4ad9850b.01bf6c","type":"function","z":"f3948f39.2753c","name":"Create Querry","func":"\nif (msg.chunguitosIndex < msg.chunguitos.length) {\n    msg.topic = \"UPDATE Players SET pType = 1 WHERE pId = \" + msg.chunguitos[msg.chunguitosIndex++];\n    //node.warn(msg.topic);\n    return [msg, undefined];\n}\nelse {\n    // Else, end execution\n    return [undefined, msg];\n}\n","outputs":2,"noerr":0,"initialize":"","finalize":"","x":620,"y":296,"wires":[["5748ef53.3561d"],["719aeadf.127b74"]]},{"id":"a9584395.03e9c","type":"http in","z":"b081fd91.ebbbd","name":"","url":"/meetup:extra","method":"get","upload":false,"swaggerDoc":"","x":130,"y":260,"wires":[["88f95911.30f478"]]},{"id":"a9b2165f.bf0f98","type":"change","z":"3ee4a50f.d7fd0a","name":"Save pId","rules":[{"t":"set","p":"pId","pt":"msg","to":"payload[0].pId","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":880,"y":440,"wires":[["973196eb.fb6c08"]]},{"id":"f288648a.460b28","type":"template","z":"3ee4a50f.d7fd0a","name":"debugCommand","field":"topic","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"INSERT INTO Opinion ('pId') values (5);","output":"str","x":990,"y":1380,"wires":[["48a1405d.80b1e"]]},{"id":"d0c8376d.265098","type":"debug","z":"3ee4a50f.d7fd0a","name":"debug","active":true,"tosidebar":false,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":1030,"y":1420,"wires":[]},{"id":"bc60b885.b810b8","type":"inject","z":"3ee4a50f.d7fd0a","name":"debugTrigger","props":[{"p":"payload"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":810,"y":1380,"wires":[["f288648a.460b28"]]},{"id":"bed677a0.37b238","type":"http in","z":"ae5a.fbf7e1a608","name":"","url":"/pollStatus","method":"get","upload":true,"swaggerDoc":"","x":120,"y":240,"wires":[["c1d10a32.3a9878"]]},{"id":"94959a30.cae2d8","type":"http response","z":"ae5a.fbf7e1a608","name":"","statusCode":"","headers":{},"x":1290,"y":300,"wires":[]},{"id":"3677bb76.358e04","type":"inject","z":"3ee4a50f.d7fd0a","name":"","props":[],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","x":124,"y":1462,"wires":[["f3ba8deb.cb307"]]},{"id":"da65739a.21643","type":"function","z":"3ee4a50f.d7fd0a","name":"init loop","func":"msg.index = 1;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":940,"y":60,"wires":[["8ab5fcbd.c3b78"]]},{"id":"8ab5fcbd.c3b78","type":"function","z":"3ee4a50f.d7fd0a","name":"from 1 to 5","func":"if (msg.index++ < 5) {\n    return msg;\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","x":1110,"y":60,"wires":[["f45e1f7c.efec9"]]},{"id":"4c692530.1c212c","type":"http in","z":"ae5a.fbf7e1a608","name":"","url":"/getDB","method":"get","upload":true,"swaggerDoc":"","x":110,"y":420,"wires":[["1ee5cf6.2dabc31"]]},{"id":"e26a7270.ed586","type":"inject","z":"3ee4a50f.d7fd0a","name":"","props":[],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","x":126,"y":1520,"wires":[["754d02fc.e5cd6c"]]},{"id":"a711c95b.837638","type":"change","z":"ae5a.fbf7e1a608","name":"Store players","rules":[{"t":"set","p":"players","pt":"flow","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":490,"y":420,"wires":[["ac1600d8.f8a54"]]},{"id":"973196eb.fb6c08","type":"function","z":"3ee4a50f.d7fd0a","name":"template","func":"msg.topic = \"INSERT INTO Opinion (pId) VALUES (\" + msg.pId + \");\"\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":600,"y":480,"wires":[["2e0a2639.c0c08a"]]},{"id":"f6c5efb2.f7285","type":"function","z":"3ee4a50f.d7fd0a","name":"init autoPlayers","func":"msg.index = 0;\nmsg.players = [\n    {user: \"Jorge\"},\n    {user: \"Paula F\"},\n    {user: \"Paula C\"},\n    {user: \"Ana\"},\n    {user: \"Laura\"},\n    {user: \"Adrian\"}\n];\nmsg.payload = {};\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":500,"y":160,"wires":[["5fb94c72.4231f4"]]},{"id":"5fb94c72.4231f4","type":"function","z":"3ee4a50f.d7fd0a","name":"for each player","func":"if (msg.index < msg.players.length) {\n    msg.payload.name = msg.players[msg.index++].user;\n    // node.warn(msg.players);\n    // node.warn(msg.players[msg.index - 1]);\n    return msg;\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","x":700,"y":160,"wires":[["d07c37b0.aa8a78","991c8d.2321337"]]},{"id":"d07c37b0.aa8a78","type":"function","z":"3ee4a50f.d7fd0a","name":"void","func":"\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":850,"y":160,"wires":[["5fb94c72.4231f4"]]},{"id":"a097e8d5.bec9d8","type":"http in","z":"3ee4a50f.d7fd0a","name":"","url":"/updatePlayersOrder.php","method":"post","upload":false,"swaggerDoc":"","x":170,"y":780,"wires":[["52b1c2e4.9eb2ec"]]},{"id":"52b1c2e4.9eb2ec","type":"function","z":"3ee4a50f.d7fd0a","name":"init loop","func":"msg.index = 0;\nmsg.newOrder = msg.payload.newOrder;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":380,"y":780,"wires":[["7b38b805.9f63e8"]]},{"id":"7b38b805.9f63e8","type":"function","z":"3ee4a50f.d7fd0a","name":"for each","func":"if (msg.index < msg.newOrder.length) {\n    msg.topic = \"UPDATE Players SET groupPos = '\" + msg.newOrder[msg.index].groupPos + \"' WHERE pId = (\" + msg.newOrder[msg.index].pId + \");\";\n    msg.index++;\n    return [msg, undefined];\n}\nelse {\n    // Loop ended\n    return [undefined, msg];\n}","outputs":2,"noerr":0,"initialize":"","finalize":"","x":860,"y":780,"wires":[["21baca11.458d86"],["f03e7137.50693"]]},{"id":"f03e7137.50693","type":"template","z":"3ee4a50f.d7fd0a","name":"Create response for user device","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"Players order updated","output":"str","x":1090,"y":840,"wires":[["6a7be78a.149938"]]},{"id":"719aeadf.127b74","type":"template","z":"f3948f39.2753c","name":"Create response for user device","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"Game starting now","output":"str","x":872,"y":357,"wires":[["ff1269fd.2758b8"]]},{"id":"f3fb09c.b8da0f8","type":"function","z":"3ee4a50f.d7fd0a","name":"Return response if needed","func":"if (msg.res) return msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":940,"y":520,"wires":[["6a7be78a.149938"]]},{"id":"8ace9097.fb066","type":"http in","z":"b081fd91.ebbbd","name":"","url":"/missionPoll:extra","method":"get","upload":false,"swaggerDoc":"","x":140,"y":300,"wires":[["313b40c.83738c"]]},{"id":"c03fd44e.f144b8","type":"function","z":"f3948f39.2753c","name":"Select the leader","func":"let players = msg.payload; // Array of players\nlet leader_pId = Math.floor(Math.random() * players.length) + 1;\n\nmsg.topic = \"UPDATE Missions SET leaderId = (\" + leader_pId + \") WHERE mId = 1;\";\n\nglobal.set(\"playersLen\", players.length); // Store the number of players in the game\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":710,"y":240,"wires":[["7c067fa9.b0485"]]},{"id":"a5c3989f.652b18","type":"debug","z":"f3948f39.2753c","name":"log debug","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"\"Starting game\"","targetType":"jsonata","statusVal":"","statusType":"auto","x":280,"y":200,"wires":[]},{"id":"ba209158.bc5bf","type":"change","z":"3ee4a50f.d7fd0a","name":"Save user pId as msg.pId","rules":[{"t":"set","p":"pId","pt":"msg","to":"payload.pId","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":590,"y":600,"wires":[["654c5e6d.d9e66"]]},{"id":"68eea9b.91db258","type":"function","z":"3ee4a50f.d7fd0a","name":"get filename","func":"msg.filename = \"/tmp/userIcons/userIcon\" + msg.user + msg.pId + \".png\";\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":310,"y":660,"wires":[["56cae460.d8aa9c"]]},{"id":"654c5e6d.d9e66","type":"change","z":"3ee4a50f.d7fd0a","name":"Save img","rules":[{"t":"set","p":"img","pt":"msg","to":"payload.img","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":780,"y":600,"wires":[["68eea9b.91db258"]]},{"id":"5a8eed85.5df174","type":"debug","z":"3ee4a50f.d7fd0a","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":310,"y":560,"wires":[]},{"id":"7615c217.df0efc","type":"change","z":"3ee4a50f.d7fd0a","name":"Create response for user device","rules":[{"t":"set","p":"payload","pt":"msg","to":"pId","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":670,"y":520,"wires":[["f3fb09c.b8da0f8"]]},{"id":"574b5b49.2f9954","type":"change","z":"3ee4a50f.d7fd0a","name":"Save user pId as msg.pId","rules":[{"t":"set","p":"user","pt":"msg","to":"payload.user","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":350,"y":600,"wires":[["ba209158.bc5bf"]]},{"id":"c749d650.a0bfb8","type":"sqlite","z":"3ee4a50f.d7fd0a","mydb":"a5762d7.f21efd","sqlquery":"fixed","sql":"CREATE TABLE 'Players' (\n\t'pId' INTEGER PRIMARY KEY AUTOINCREMENT,\n\t'name' VARCHAR,\n\t'groupPos' INT DEFAULT NULL,\n\t'pType' INT DEFAULT 0\n);\n","name":"Create Players table","x":306,"y":58,"wires":[["695efddd.b56fb4","339be272.64cffe"]]},{"id":"32422764.0b24c8","type":"sqlite","z":"3ee4a50f.d7fd0a","mydb":"a5762d7.f21efd","sqlquery":"msg.topic","sql":"INSERT INTO Players ('name') values (\"Jorge\");","name":"Add playerName to Players table","x":820,"y":400,"wires":[["aeccccbe.c3651"]]},{"id":"3238142f.bab64c","type":"sqlite","z":"3ee4a50f.d7fd0a","mydb":"a5762d7.f21efd","sqlquery":"fixed","sql":"SELECT * FROM Players;","name":"Elements on players List","x":310,"y":1280,"wires":[["22d63c4a.f482f4"]]},{"id":"171f5cd2.8a69c3","type":"sqlite","z":"3ee4a50f.d7fd0a","mydb":"a5762d7.f21efd","sqlquery":"msg.topic","sql":"INSERT INTO Players ('name') values (\"Jorge\");","name":"Get pId","x":740,"y":440,"wires":[["a9b2165f.bf0f98"]]},{"id":"c6dd8369.83d07","type":"sqlite","z":"3ee4a50f.d7fd0a","mydb":"a5762d7.f21efd","sqlquery":"fixed","sql":"SELECT * FROM Imgs;","name":"Elements on Imgs List","x":300,"y":1340,"wires":[["22d63c4a.f482f4"]]},{"id":"ef757fa9.1b623","type":"sqlite","z":"3ee4a50f.d7fd0a","mydb":"a5762d7.f21efd","sqlquery":"fixed","sql":"SELECT * FROM Opinion;","name":"Elements on Opinion List","x":310,"y":1400,"wires":[["22d63c4a.f482f4"]]},{"id":"695efddd.b56fb4","type":"sqlite","z":"3ee4a50f.d7fd0a","mydb":"a5762d7.f21efd","sqlquery":"fixed","sql":"CREATE TABLE 'Opinion' (\n\t'pId' INTEGER PRIMARY KEY,\n\t'val' INTEGER DEFAULT 0\n);","name":"Create Opinion table","x":527,"y":58,"wires":[[]]},{"id":"9851184b.a7b988","type":"sqlite","z":"3ee4a50f.d7fd0a","mydb":"a5762d7.f21efd","sqlquery":"msg.topic","sql":"INSERT INTO Players ('name') values (\"Jorge\");","name":"Update vote","x":530,"y":1060,"wires":[["356bab9a.e79fe4"]]},{"id":"a93829ab.1c00e8","type":"sqlite","z":"ae5a.fbf7e1a608","mydb":"a5762d7.f21efd","sqlquery":"msg.topic","sql":"INSERT INTO Players ('name') values (\"Jorge\");","name":"Get pId","x":680,"y":120,"wires":[["c0d1b3f6.b4cc3"]]},{"id":"1417bd61.8d01d3","type":"sqlite","z":"ae5a.fbf7e1a608","mydb":"a5762d7.f21efd","sqlquery":"fixed","sql":"SELECT * from Players;","name":"Get Player table","x":340,"y":180,"wires":[["94959a30.cae2d8"]]},{"id":"ff3949b9.b3e1f8","type":"sqlite","z":"f3948f39.2753c","mydb":"a5762d7.f21efd","sqlquery":"fixed","sql":"SELECT * from Players;","name":"Get Player table","x":520,"y":240,"wires":[["c03fd44e.f144b8","a9ebdb1f.09dd18"]]},{"id":"5748ef53.3561d","type":"sqlite","z":"f3948f39.2753c","mydb":"a5762d7.f21efd","sqlquery":"msg.topic","sql":"","name":"Create chunguito","x":826,"y":296,"wires":[["4ad9850b.01bf6c"]]},{"id":"2e0a2639.c0c08a","type":"sqlite","z":"3ee4a50f.d7fd0a","mydb":"a5762d7.f21efd","sqlquery":"msg.topic","sql":"INSERT INTO Players ('name') values (\"Jorge\");","name":"Add playerName to opinion table","x":810,"y":480,"wires":[["7615c217.df0efc"]]},{"id":"48a1405d.80b1e","type":"sqlite","z":"3ee4a50f.d7fd0a","mydb":"a5762d7.f21efd","sqlquery":"msg.topic","sql":"INSERT INTO Players ('name') values (\"Jorge\");","name":"debugQuerry","x":890,"y":1420,"wires":[["d0c8376d.265098"]]},{"id":"c1d10a32.3a9878","type":"sqlite","z":"ae5a.fbf7e1a608","mydb":"a5762d7.f21efd","sqlquery":"fixed","sql":"SELECT * from Opinion;","name":"Get Opinion table","x":350,"y":240,"wires":[["94959a30.cae2d8"]]},{"id":"339be272.64cffe","type":"sqlite","z":"3ee4a50f.d7fd0a","mydb":"a5762d7.f21efd","sqlquery":"fixed","sql":"CREATE TABLE 'Missions' (\n\t'mId' INTEGER PRIMARY KEY AUTOINCREMENT,\n\t'active' INT DEFAULT 0,\n\t'leaderId' INT DEFAULT NULL,\n\t'vYes' INT DEFAULT NULL,\n\t'vNo' INT DEFAULT NULL,\n\t'mRes' INT DEFAULT NULL\n);\n","name":"Create Missions table","x":520,"y":100,"wires":[["e0ad4701.cd37f8","4ba100fa.7f46e"]]},{"id":"f3ba8deb.cb307","type":"sqlite","z":"3ee4a50f.d7fd0a","mydb":"a5762d7.f21efd","sqlquery":"fixed","sql":"SELECT * FROM Missions;","name":"Elements on Missions List","x":309,"y":1462,"wires":[["22d63c4a.f482f4"]]},{"id":"e0ad4701.cd37f8","type":"sqlite","z":"3ee4a50f.d7fd0a","mydb":"a5762d7.f21efd","sqlquery":"fixed","sql":"INSERT INTO Missions (active) VALUES (1);","name":"Create Active mission","x":760,"y":60,"wires":[["da65739a.21643"]]},{"id":"f45e1f7c.efec9","type":"sqlite","z":"3ee4a50f.d7fd0a","mydb":"a5762d7.f21efd","sqlquery":"fixed","sql":"INSERT INTO Missions (active) VALUES (0);","name":"Create mission not active","x":1310,"y":60,"wires":[["8ab5fcbd.c3b78"]]},{"id":"276c8e4c.72cb02","type":"sqlite","z":"ae5a.fbf7e1a608","mydb":"a5762d7.f21efd","sqlquery":"fixed","sql":"SELECT * from Missions;","name":"Get Missions table","x":290,"y":600,"wires":[["2de415ac.4c685a"]]},{"id":"4ba100fa.7f46e","type":"sqlite","z":"3ee4a50f.d7fd0a","mydb":"a5762d7.f21efd","sqlquery":"fixed","sql":"CREATE TABLE 'MissionTeam' (\n\t'mId' INT,\n\t'pId' INT,\n\t'vote' INT DEFAULT NULL\n);\n","name":"Create MissionTeam table","x":770,"y":100,"wires":[["9a1b58b.4e288a8"]]},{"id":"754d02fc.e5cd6c","type":"sqlite","z":"3ee4a50f.d7fd0a","mydb":"a5762d7.f21efd","sqlquery":"fixed","sql":"SELECT * FROM MissionTeam;","name":"Elements on MissionTeam List","x":330,"y":1520,"wires":[["22d63c4a.f482f4"]]},{"id":"1ee5cf6.2dabc31","type":"sqlite","z":"ae5a.fbf7e1a608","mydb":"a5762d7.f21efd","sqlquery":"fixed","sql":"SELECT * from Players;","name":"Get Players table","x":290,"y":420,"wires":[["a711c95b.837638"]]},{"id":"21baca11.458d86","type":"sqlite","z":"3ee4a50f.d7fd0a","mydb":"a5762d7.f21efd","sqlquery":"msg.topic","sql":"","name":"Update player groupPos","x":1070,"y":780,"wires":[["7b38b805.9f63e8"]]},{"id":"7c067fa9.b0485","type":"sqlite","z":"f3948f39.2753c","mydb":"a5762d7.f21efd","sqlquery":"msg.topic","sql":"INSERT INTO Players ('name') values (\"Jorge\");","name":"Update leader of 1º mission","x":940,"y":240,"wires":[[]]},{"id":"1e8ebb5e.eec3a5","type":"image","z":"b081fd91.ebbbd","name":"","width":160,"data":"payload","dataType":"msg","thumbnail":false,"active":false,"pass":false,"outputs":0,"x":760,"y":652,"wires":[]},{"id":"f8d56b3b.3bb1f8","type":"image","z":"ae5a.fbf7e1a608","name":"","width":160,"data":"payload","dataType":"msg","thumbnail":false,"active":true,"outputs":0,"x":1260,"y":80,"wires":[]},{"id":"c7e93643.f35868","type":"image","z":"3ee4a50f.d7fd0a","name":"","width":160,"data":"payload","dataType":"msg","thumbnail":false,"active":true,"pass":false,"outputs":0,"x":640,"y":720,"wires":[]},{"id":"49f4f8d2.a7c098","type":"file in","z":"b081fd91.ebbbd","name":"HTML","filename":"","format":"utf8","chunk":false,"sendError":false,"encoding":"none","x":930,"y":199,"wires":[["25e9bb88.679b24"]]},{"id":"69c3e7eb.021098","type":"function","z":"b081fd91.ebbbd","name":"createPlayers","func":"msg.NAME = \"createPlayer\";\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":360,"y":97,"wires":[["ea1ce062.d9564"]]},{"id":"25e9bb88.679b24","type":"function","z":"b081fd91.ebbbd","name":"Store HTML and get JS","func":"flow.set(\"html\", msg.payload);\nmsg.filename = flow.get(\"jsFileName\");\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":790,"y":238,"wires":[["8905bd5f.da4f6"]]},{"id":"8905bd5f.da4f6","type":"file in","z":"b081fd91.ebbbd","name":"JS","filename":"","format":"utf8","chunk":false,"sendError":false,"encoding":"none","x":970,"y":238,"wires":[["25104b7c.1b3214"]]},{"id":"ea1ce062.d9564","type":"function","z":"b081fd91.ebbbd","name":"Get Files Names","func":"let dir = global.get(\"DIR\"); // Get directory\nlet client = global.get(\"CLIENT\");\nlet NAME = msg.NAME;\n\nNAME = NAME + \"/\" + NAME;\nconst HTML = NAME + \".html\";\nconst JS = NAME + \".js\";\n\nmsg.filename = dir + client + HTML;\nflow.set(\"jsFileName\", dir + client + JS);\n\n// Get names of common files\nlet resources = global.get(\"RES\");\nflow.set(\"commonJS\", dir + resources + \"JS/common.js\");\nflow.set(\"styleCSS\", dir + resources + \"CSS/style.css\");\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":770,"y":199,"wires":[["49f4f8d2.a7c098"]]},{"id":"c036542c.d78418","type":"function","z":"b081fd91.ebbbd","name":"waitingRoom","func":"msg.NAME = \"waitingRoom\";\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":350,"y":140,"wires":[["ea1ce062.d9564"]]},{"id":"edde527e.445e8","type":"function","z":"b081fd91.ebbbd","name":"rootMenu","func":"msg.NAME = \"rootMenu\";\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":340,"y":180,"wires":[["ea1ce062.d9564"]]},{"id":"b726ee89.6e5b4","type":"function","z":"b081fd91.ebbbd","name":"mainMenu","func":"msg.NAME = \"mainMenu\";\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":350,"y":220,"wires":[["ea1ce062.d9564"]]},{"id":"88f95911.30f478","type":"function","z":"b081fd91.ebbbd","name":"meetup","func":"msg.NAME = \"meetup\";\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","x":340,"y":260,"wires":[["ea1ce062.d9564"]]},{"id":"313b40c.83738c","type":"function","z":"b081fd91.ebbbd","name":"missionPoll","func":"let STATES = global.get(\"STATES\");\nlet currentState = global.get(\"currentState\");\n\nif (currentState != STATES.MISSION) { // If not on mission now\n    msg.NAME = \"waitingRoom\";\n    return [msg, null];\n}\nelse {\n    return [null, msg];\n}\n    ","outputs":2,"noerr":0,"initialize":"","finalize":"","libs":[],"x":350,"y":300,"wires":[["ea1ce062.d9564"],["208b4c3f.5c7294"]]},{"id":"966c82a3.148d3","type":"function","z":"b081fd91.ebbbd","name":"Create constants","func":"global.set(\"DIR\", \"/home/jkutkut/github/TheResistance/\");\nglobal.set(\"CLIENT\", \"Client/\");\nglobal.set(\"RES\", \"Res/\");\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":310,"y":58,"wires":[[]]},{"id":"f31b2576.9aad98","type":"inject","z":"b081fd91.ebbbd","name":"Started","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":true,"onceDelay":"0","topic":"init of FSM","payload":"","payloadType":"date","x":126,"y":58,"wires":[["966c82a3.148d3"]]},{"id":"18d0f322.ae2b6d","type":"function","z":"b081fd91.ebbbd","name":"Generate HTML","func":"msg.payload = flow.get(\"html\");\n\nlet regexArr = [\n    // /<link rel=\"stylesheet\" href=\"[^\"]+\\/style.css\">/,\n    // /<script src=\"[^\"]+common.js\"><\\/script>/,\n    /<script src=\"[A-Za-z]+.js\"><\\/script>/\n];\nlet files = [\n    // \"styleCSS\",\n    // \"commonJS\",\n    \"jscode\"\n];\nlet htmlTags = [\n    // [\"<style>\", \"</style>\"],\n    // [\"<script>\", \"</script>\"],\n    [\"<script>\", \"</script>\"]\n];\n\n\nfor (let i = 0; i < files.length; i++) {\n    let f = files[i];\n    let regex = regexArr[i];\n    let tag = htmlTags[i];\n    \n    msg.payload = msg.payload.replace(regex, tag[0] + flow.get(f) + tag[1]);\n}\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":900,"y":280,"wires":[["785d8381.488e5c"]]},{"id":"25104b7c.1b3214","type":"function","z":"b081fd91.ebbbd","name":"Store JS","func":"flow.set(\"jscode\", msg.payload);\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":740,"y":280,"wires":[["18d0f322.ae2b6d"]]},{"id":"38549207.1bddae","type":"function","z":"3ee4a50f.d7fd0a","name":"create template","func":"msg.topic = \"UPDATE Opinion SET val = '\" + msg.payload.opinion + \"' WHERE pId = (\" + msg.payload.pId + \");\";\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":360,"y":1060,"wires":[["9851184b.a7b988"]]},{"id":"67b74185.fcca7","type":"http in","z":"ae5a.fbf7e1a608","name":"","url":"/getpId","method":"get","upload":true,"swaggerDoc":"","x":110,"y":720,"wires":[["88b4fea.f67b"]]},{"id":"88b4fea.f67b","type":"change","z":"ae5a.fbf7e1a608","name":"Save UserName as msg.user","rules":[{"t":"set","p":"user","pt":"msg","to":"payload.username","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":320,"y":720,"wires":[["8353c495.0bf408"]]},{"id":"8353c495.0bf408","type":"template","z":"ae5a.fbf7e1a608","name":"","field":"topic","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"SELECT pId from Players WHERE name = '{{user}}';","output":"str","x":520,"y":720,"wires":[["c2c6fa92.79a148"]]},{"id":"c2c6fa92.79a148","type":"sqlite","z":"ae5a.fbf7e1a608","mydb":"a5762d7.f21efd","sqlquery":"msg.topic","sql":"INSERT INTO Players ('name') values (\"Jorge\");","name":"Get pId","x":660,"y":720,"wires":[["e2222947.8c4d48"]]},{"id":"e2222947.8c4d48","type":"change","z":"ae5a.fbf7e1a608","name":"Save pId","rules":[{"t":"set","p":"payload","pt":"msg","to":"payload[0].pId","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":800,"y":720,"wires":[["94959a30.cae2d8"]]},{"id":"a7fcf63f.d2e978","type":"http in","z":"ae5a.fbf7e1a608","name":"","url":"/selectedPlayers","method":"get","upload":true,"swaggerDoc":"","x":140,"y":360,"wires":[["7bac495e.096888"]]},{"id":"7bac495e.096888","type":"sqlite","z":"ae5a.fbf7e1a608","mydb":"a5762d7.f21efd","sqlquery":"fixed","sql":"SELECT * from MissionTeam;","name":"Get MissionTeam table","x":360,"y":360,"wires":[["94959a30.cae2d8"]]},{"id":"35e1937b.0b08fc","type":"http in","z":"ae5a.fbf7e1a608","name":"","url":"/missions","method":"get","upload":true,"swaggerDoc":"","x":110,"y":300,"wires":[["bf751a5f.587378"]]},{"id":"bf751a5f.587378","type":"sqlite","z":"ae5a.fbf7e1a608","mydb":"a5762d7.f21efd","sqlquery":"fixed","sql":"SELECT * from Missions;","name":"Get Missions table","x":350,"y":300,"wires":[["94959a30.cae2d8"]]},{"id":"40488f9e.352f3","type":"change","z":"ae5a.fbf7e1a608","name":"Store missionTeam","rules":[{"t":"set","p":"missionTeam","pt":"flow","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":510,"y":480,"wires":[["db960d9d.75cc2"]]},{"id":"ac1600d8.f8a54","type":"sqlite","z":"ae5a.fbf7e1a608","mydb":"a5762d7.f21efd","sqlquery":"fixed","sql":"SELECT * from MissionTeam;","name":"Get MissionTeam table","x":300,"y":480,"wires":[["40488f9e.352f3"]]},{"id":"2de415ac.4c685a","type":"function","z":"ae5a.fbf7e1a608","name":"Create MissionObject","func":"flow.set(\"missions\", msg.payload);\n\nmsg.payload = {\n    currentState: global.get(\"currentState\"),\n    players: flow.get(\"players\"),\n    missions: flow.get(\"missions\"),\n    missionTeam: flow.get(\"missionTeam\"),\n    opinion: flow.get(\"opinion\")\n};\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":740,"y":600,"wires":[["94959a30.cae2d8"]]},{"id":"7c34ebf9.bbbd54","type":"change","z":"ae5a.fbf7e1a608","name":"Store Opinion","rules":[{"t":"set","p":"opinion","pt":"flow","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":500,"y":540,"wires":[["276c8e4c.72cb02"]]},{"id":"db960d9d.75cc2","type":"sqlite","z":"ae5a.fbf7e1a608","mydb":"a5762d7.f21efd","sqlquery":"fixed","sql":"SELECT * from Opinion;","name":"Get Opinion table","x":290,"y":540,"wires":[["7c34ebf9.bbbd54"]]},{"id":"1043844a.9ef2cc","type":"http in","z":"3ee4a50f.d7fd0a","name":"","url":"/selectPlayer4mission","method":"post","upload":false,"swaggerDoc":"","x":160,"y":940,"wires":[["b39acb4b.506aa8"]]},{"id":"2c64a96.e3a4c56","type":"http in","z":"3ee4a50f.d7fd0a","name":"","url":"/removePlayer4mission","method":"post","upload":false,"swaggerDoc":"","x":160,"y":1000,"wires":[["dbecf22f.0d9e8"]]},{"id":"b39acb4b.506aa8","type":"function","z":"3ee4a50f.d7fd0a","name":"create template","func":"/*CREATE TABLE 'MissionTeam' (\n\t'mId' INTEGER,\n\t'pId' INT,\n\t'vote' INT DEFAULT NULL\n);*/\n\nlet values = [\n    msg.payload.mId,\n    msg.payload.pId\n].map(x => \"'\"+x+\"'\").join(\",\");\n\nmsg.topic = \"INSERT INTO MissionTeam (mId, pId) VALUES (\" + values + \");\";\n// msg.topic = \"INSERT INTO MissionTeam SET (mId, pId, vote) VALUES (\" + values + \");\";\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":380,"y":940,"wires":[["c89c5ec0.43e11"]]},{"id":"dbecf22f.0d9e8","type":"function","z":"3ee4a50f.d7fd0a","name":"create template","func":"/*CREATE TABLE 'MissionTeam' (\n\t'mId' INTEGER,\n\t'pId' INT,\n\t'vote' INT DEFAULT NULL\n);*/\n\nmsg.topic = \"DELETE FROM MissionTeam WHERE (mId = \" + msg.payload.mId + \") AND (pId = \" + msg.payload.pId + \");\";\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":380,"y":1000,"wires":[["c89c5ec0.43e11"]]},{"id":"c89c5ec0.43e11","type":"sqlite","z":"3ee4a50f.d7fd0a","mydb":"a5762d7.f21efd","sqlquery":"msg.topic","sql":"INSERT INTO Players ('name') values (\"Jorge\");","name":"Update playerSelected","x":600,"y":970,"wires":[["356bab9a.e79fe4"]]},{"id":"6d16c736.f217a8","type":"http in","z":"b081fd91.ebbbd","name":"","url":"/phrases.json","method":"get","upload":false,"swaggerDoc":"","x":130,"y":600,"wires":[["11829600.c6491a"]]},{"id":"11829600.c6491a","type":"function","z":"b081fd91.ebbbd","name":"Get Files Names","func":"let dir = global.get(\"DIR\"); // Get directory\nlet client = global.get(\"CLIENT\");\nmsg.filename = dir + client + \"waitingRoom/phrases.json\";\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":330,"y":600,"wires":[["83beee8.e7f911"]]},{"id":"83beee8.e7f911","type":"file in","z":"b081fd91.ebbbd","name":"HTML","filename":"","format":"utf8","chunk":false,"sendError":false,"encoding":"none","x":490,"y":600,"wires":[["b3a313d7.1a5f9"]]},{"id":"b3a313d7.1a5f9","type":"http response","z":"b081fd91.ebbbd","name":"","x":610,"y":600,"wires":[]},{"id":"28018874.84f118","type":"function","z":"f3948f39.2753c","name":"Return response if needed","func":"if (msg.res) {\n    msg.payload = msg.error;\n    return msg;\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":960,"y":60,"wires":[["1547ae53.7c3c82"]]},{"id":"1547ae53.7c3c82","type":"http response","z":"f3948f39.2753c","name":"","x":1150,"y":60,"wires":[]},{"id":"4540f886.d13858","type":"http in","z":"f3948f39.2753c","name":"","url":"/endPoll","method":"post","upload":false,"swaggerDoc":"","x":110,"y":440,"wires":[["1802c5be.8f10ba"]]},{"id":"1802c5be.8f10ba","type":"function","z":"f3948f39.2753c","name":"Check if currentState valid","func":"let STATES = global.get(\"STATES\");\n\nlet state = global.get(\"currentState\");\n\nif (state != STATES.ROUND) {\n    throw \"Can not end the current poll, the current state is not valid (\" + STATES[state] + \")\"; \n}\nelse {\n    node.warn(\"Ending poll\");\n    \n}\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":310,"y":440,"wires":[["e9ec1969.7229c8"]]},{"id":"e9ec1969.7229c8","type":"sqlite","z":"f3948f39.2753c","mydb":"a5762d7.f21efd","sqlquery":"fixed","sql":"SELECT * FROM Missions WHERE active = 1;","name":"Get current mission","x":290,"y":480,"wires":[["798d20b4.88079"]]},{"id":"ca61e277.542af","type":"debug","z":"f3948f39.2753c","name":"log debug","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":580,"y":440,"wires":[]},{"id":"798d20b4.88079","type":"function","z":"f3948f39.2753c","name":"store mission","func":"msg.currentMission = msg.payload[0];\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":470,"y":480,"wires":[["ca61e277.542af","58011f02.f8b5d"]]},{"id":"537db9c1.cec818","type":"sqlite","z":"f3948f39.2753c","mydb":"a5762d7.f21efd","sqlquery":"fixed","sql":"UPDATE Missions SET active = 0 WHERE active = 1;","name":"mission not active now","x":1080,"y":760,"wires":[["a78fcd1.fb22e3"]]},{"id":"d77755fb.383c68","type":"function","z":"f3948f39.2753c","name":"Check if enough players","func":"const playersPerM = {\n    5: [ 2, 3, 2, 3, 3 ],\n    6: [ 2, 3, 4, 3, 4 ],\n    7: [ 2, 3, 3, 4, 4 ],\n    8: [ 3, 4, 4, 5, 5 ],\n    9: [ 3, 4, 4, 5, 5 ],\n    10:[ 3, 4, 4, 5, 5 ]\n}\n\nmsg.teamPlayers = msg.payload; // Store players in missions\nlet teamLen = global.get(\"playersLen\"); // number of players playing\n\nlet maxPlayers = playersPerM[teamLen][msg.currentMission.mId - 1];\n\n\nlet missionTeamLength = 0;\nfor (let p of msg.teamPlayers) { // Count number of players\n    if (p.mId == msg.currentMission.mId) {\n        missionTeamLength++;\n    }\n}\n\nnode.warn(\"Next mission require \" + maxPlayers + \", selected \" + missionTeamLength);\nif (missionTeamLength != maxPlayers) {\n    node.warn(\"Invalid number of players selected, missing \" + (maxPlayers - missionTeamLength));\n    //throw new Error(\"Invalid number of players\");\n}\nelse {\n    node.warn(\"Ready for next phase\");\n    return msg;\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":590,"y":520,"wires":[["b369d090.59276"]]},{"id":"58011f02.f8b5d","type":"sqlite","z":"f3948f39.2753c","mydb":"a5762d7.f21efd","sqlquery":"fixed","sql":"SELECT * FROM MissionTeam;","name":"Elements on MissionTeam List","x":330,"y":520,"wires":[["d77755fb.383c68"]]},{"id":"82f94fff.d2b0c","type":"debug","z":"f3948f39.2753c","name":"ENDGAME","active":true,"tosidebar":false,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1350,"y":840,"wires":[]},{"id":"b369d090.59276","type":"sqlite","z":"f3948f39.2753c","mydb":"a5762d7.f21efd","sqlquery":"fixed","sql":"SELECT * FROM Opinion;","name":"Elements on Opinion List","x":310,"y":560,"wires":[["9d59f20a.adc9c"]]},{"id":"9d59f20a.adc9c","type":"function","z":"f3948f39.2753c","name":"Determine poll outcome","func":"msg.opinion = msg.payload; // save opinion table\n\n\nlet pollResult = 0;\nmsg.vYes = 0;\nmsg.vNo = 0;\nfor (let o of msg.opinion) {\n    pollResult += o.val;\n    if (o.val == 1) msg.vYes++;\n    else if (o.val == -1) msg.vNo++;\n}\n\n\nif (pollResult > 0) {\n    node.warn(\"Mission valid, creating team\");\n    return [msg, null]; // Create mission\n}\nelse {\n    node.warn(\"Mission invalid\");\n    return [null, msg];\n}\nreturn msg;","outputs":2,"noerr":0,"initialize":"","finalize":"","libs":[],"x":590,"y":560,"wires":[["e26c20ed.28539","5736f0b9.8aeb"],["37b799ae.88bae6","5736f0b9.8aeb"]]},{"id":"5736f0b9.8aeb","type":"sqlite","z":"f3948f39.2753c","mydb":"a5762d7.f21efd","sqlquery":"fixed","sql":"UPDATE Opinion SET val = 0 WHERE val = 1;","name":"Reset Opinion table","x":870,"y":500,"wires":[[]]},{"id":"ff1269fd.2758b8","type":"http response","z":"f3948f39.2753c","name":"","x":1070,"y":357,"wires":[]},{"id":"7f16269b.a92298","type":"function","z":"f3948f39.2753c","name":"Atempt Enable next Mission","func":"let STATES = global.get(\"STATES\");\n\n\n// Check if GameOver\nmsg.missions = msg.payload;\n\nlet resis = 0, chung = 0, gameResult;\nfor (let m of msg.missions) {\n    if (m.mRes == null) break;\n    else if (m.mRes == 0) resis++;\n    else chung++;\n}\nif (resis >= 3) gameResult = 0;\nelse if (chung >= 3) gameResult = 1;\n\nnode.warn(resis + \" -- \" + chung + \" => \" + gameResult);\n\nif (gameResult != undefined || // If team has won or\n    msg.currentMissionId >= 5) { // If last mission reached, gameOver\n    global.set(\"currentState\", STATES.END); // Change state to endGame\n    global.set(\"gameResult\", gameResult); // Store gameResult\n    node.warn(\"Game ended\");\n    return [null, msg];\n}\nelse { // If now we going to next mission\n    let nextLeaderId = (msg.currentMission.leaderId + 1) % global.get(\"playersLen\");\n    node.warn(\"next leader is \" + nextLeaderId);\n    msg.topic = \"UPDATE Missions SET active = 1, leaderId = \" + nextLeaderId + \" WHERE mId = \" + (msg.currentMission.mId + 1);\n    return [msg, null];    \n}\n","outputs":2,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1101,"y":807,"wires":[["43fa1d9c.6c34d4"],["82f94fff.d2b0c"]]},{"id":"e26c20ed.28539","type":"function","z":"f3948f39.2753c","name":"Update Mission created","func":"let STATES = global.get(\"STATES\");\n\nglobal.set(\"currentState\", STATES.MISSION); // Change state\n\nglobal.set(\"missionFailedTimes\", 0); // Reset counter\n\nmsg.mRes = \"NULL\";\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":870,"y":560,"wires":[["7d98bc44.d312d4","6c23cda7.8caae4","cda7d591.2942f8"]]},{"id":"37b799ae.88bae6","type":"function","z":"f3948f39.2753c","name":"Handle failed poll","func":"let STATES = global.get(\"STATES\");\n\nglobal.set(\"missionFailedTimes\", global.get(\"missionFailedTimes\") + 1);\n\nif (global.get(\"missionFailedTimes\") < 5) { // If just failed poll, create a new one\n    node.warn(\"Mission not created, attempting again\");\n    msg.currentMission.mId--; // one minus to repeat mission\n    return [msg, null];\n}\nelse { // if mission has failed multiple times -> Lost round\n    msg.mRes = 1; // Mission won by chunguitos\n    node.warn(\"Mission failed because it has failed 5 times\");\n    return [null, msg];\n}\n","outputs":2,"noerr":0,"initialize":"","finalize":"","libs":[],"x":850,"y":680,"wires":[["a3be3f45.ad6a3","2b68fa6f.2ab936","cda7d591.2942f8","537db9c1.cec818"],["c9804afe.69d488","6c23cda7.8caae4","cda7d591.2942f8","537db9c1.cec818"]]},{"id":"6c23cda7.8caae4","type":"function","z":"f3948f39.2753c","name":"Update result of normal Poll","func":"msg.topic = \"UPDATE Missions SET \";\nif (msg.vYes) {\n    msg.topic += \"mRes = \" + msg.mRes + \", vYes = \" + msg.vYes + \", vNo = \" + msg.vNo;\n}\nelse {\n    msg.topic += \"mRes = \" + msg.mRes;\n}\nmsg.topic += \" WHERE mId = \" + msg.currentMission.mId;\n\n// node.warn(msg.topic);\n// node.warn(msg.currentMission.mId);\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1200,"y":560,"wires":[["1d33cd2c.065ca3"]]},{"id":"1d33cd2c.065ca3","type":"sqlite","z":"f3948f39.2753c","mydb":"a5762d7.f21efd","sqlquery":"msg.topic","sql":"INSERT INTO Players ('name') values (\"Jorge\");","name":"Execute query","x":1420,"y":560,"wires":[[]]},{"id":"43fa1d9c.6c34d4","type":"sqlite","z":"f3948f39.2753c","mydb":"a5762d7.f21efd","sqlquery":"msg.topic","sql":"INSERT INTO Players ('name') values (\"Jorge\");","name":"Enable next mission","x":1344,"y":800,"wires":[["5b800c91.d729d4"]]},{"id":"c9804afe.69d488","type":"debug","z":"f3948f39.2753c","name":"5 fails making team","active":true,"tosidebar":false,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1110,"y":700,"wires":[]},{"id":"a3be3f45.ad6a3","type":"debug","z":"f3948f39.2753c","name":"Fail making team","active":true,"tosidebar":false,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1110,"y":620,"wires":[]},{"id":"7d98bc44.d312d4","type":"debug","z":"f3948f39.2753c","name":"team made","active":true,"tosidebar":false,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1070,"y":520,"wires":[]},{"id":"7ea6e723.6355f8","type":"function","z":"f3948f39.2753c","name":"Invalid response","func":"msg.payload = \"f\";\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":800,"y":1080,"wires":[["a53863af.9150a"]]},{"id":"bd4f8fa4.971b6","type":"function","z":"f3948f39.2753c","name":"If state is not the current","func":"let s = parseInt(msg.payload.currentState);\nif (s == -1 || // If I want to reconect\n    s != global.get(\"currentState\")) {\n    // If asked state is current\n    return [msg, null];\n}\nreturn [null, msg]; // if not state is not the current","outputs":2,"noerr":0,"initialize":"","finalize":"","libs":[],"x":370,"y":980,"wires":[["525035de.1f9f0c"],["7ea6e723.6355f8"]]},{"id":"bc551642.9bd898","type":"debug","z":"f3948f39.2753c","name":"log debug","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":320,"y":760,"wires":[]},{"id":"7e07dab8.9dc3e4","type":"function","z":"f3948f39.2753c","name":"Go to Mission","func":"msg.payload = \"missionPoll.html\";\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":800,"y":1000,"wires":[["a53863af.9150a"]]},{"id":"208b4c3f.5c7294","type":"sqlite","z":"b081fd91.ebbbd","mydb":"a5762d7.f21efd","sqlquery":"fixed","sql":"SELECT * FROM MissionTeam;","name":"Elements on MissionTeam List","x":190,"y":340,"wires":[["21fa9b25.d0bab4"]]},{"id":"21fa9b25.d0bab4","type":"function","z":"b081fd91.ebbbd","name":"Determine if player is going to mission","func":"let missionTeam = msg.payload;\nlet pId = msg.req.query.pId; // Get pId of user\n\nlet maxIndex = 0;\nlet playerInMission = false;\n\n\nfor (let p of missionTeam) {\n    if (p.mId > maxIndex) {\n        playerInMission = false;\n        maxIndex = p.mId;\n    }\n    \n    if (p.mId == maxIndex) {\n        if (p.pId == pId) {\n            playerInMission = true;\n        }\n    }\n}\n\nif (playerInMission) {\n    node.warn(msg.req.query.username + \" is going to mission\");\n    msg.NAME = \"missionPoll\";\n}\nelse {\n    node.warn(msg.req.query.username + \" waits\");\n    msg.NAME = \"waitingRoom\"\n}\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":490,"y":340,"wires":[["ea1ce062.d9564"]]},{"id":"a43a0b82.6cbef8","type":"http in","z":"3ee4a50f.d7fd0a","name":"","url":"/voteMission","method":"post","upload":false,"swaggerDoc":"","x":130,"y":1120,"wires":[["2e1f90b1.b64b8"]]},{"id":"2e1f90b1.b64b8","type":"function","z":"3ee4a50f.d7fd0a","name":"Store user info","func":"msg.userObj = msg.payload;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":320,"y":1120,"wires":[["f4821ed3.44641"]]},{"id":"f4821ed3.44641","type":"sqlite","z":"3ee4a50f.d7fd0a","mydb":"a5762d7.f21efd","sqlquery":"fixed","sql":"SELECT * FROM Missions;","name":"Elements on Missions List","x":530,"y":1120,"wires":[["f6edd6ee.59c138"]]},{"id":"f6edd6ee.59c138","type":"function","z":"3ee4a50f.d7fd0a","name":"Create query","func":"let missions = msg.payload;\n\nfor (let m of missions) {\n    if (m.active == 1) { // If mission active, vote here\n        msg.currentMission = m;\n        msg.topic = \"UPDATE MissionTeam SET vote = \" + msg.userObj.vote +\n        \" WHERE mId = \" + m.mId + \" AND pId = \" + msg.userObj.pId;\n        return msg;\n    }   \n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":730,"y":1120,"wires":[["f078e2da.4aa09"]]},{"id":"f078e2da.4aa09","type":"sqlite","z":"3ee4a50f.d7fd0a","mydb":"a5762d7.f21efd","sqlquery":"msg.topic","sql":"INSERT INTO Players ('name') values (\"Jorge\");","name":"Update MissionVote","x":920,"y":1120,"wires":[["e27f003b.94f7e","3a2369f2.380cf6"]]},{"id":"e27f003b.94f7e","type":"template","z":"3ee4a50f.d7fd0a","name":"Create response for user device","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"Vote made","output":"str","x":1170,"y":1120,"wires":[["6a7be78a.149938"]]},{"id":"3a2369f2.380cf6","type":"sqlite","z":"3ee4a50f.d7fd0a","mydb":"a5762d7.f21efd","sqlquery":"fixed","sql":"SELECT * FROM MissionTeam;","name":"Elements on MissionTeam List","x":290,"y":1160,"wires":[["1d18cf82.3751c"]]},{"id":"1d18cf82.3751c","type":"function","z":"3ee4a50f.d7fd0a","name":"Check status of poll","func":"let missionTeam = msg.payload;\n\nlet hasFinished = true;\nmsg.vYes = 0;\nmsg.vNo = 0;\nfor (let p of missionTeam) {\n    if (p.mId == msg.currentMission.mId) {\n        switch(p.vote) {\n            case 1:\n                msg.vNo++;\n                break;\n            case 0:\n                msg.vYes++;\n                break;\n            case null:\n                node.warn(\"Poll not finished\");\n                return null;\n        }\n    }\n}\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":530,"y":1160,"wires":[["cbbbe58f.deb188"]]},{"id":"cbbbe58f.deb188","type":"link out","z":"3ee4a50f.d7fd0a","name":"","links":["9ab92bd6.a226b8"],"x":655,"y":1160,"wires":[]},{"id":"9ab92bd6.a226b8","type":"link in","z":"f3948f39.2753c","name":"","links":["cbbbe58f.deb188"],"x":195,"y":700,"wires":[["bc551642.9bd898","7b244997.53cbe8"]]},{"id":"7b244997.53cbe8","type":"function","z":"f3948f39.2753c","name":"Determine poll outcome","func":"let sum = msg.vYes + msg.vNo; \nlet thisMissionRequires2fails = false;\n\nif (msg.currentMission.mId == 4 && sum >= 4) {\n    // If this executes, there're at least 7 playes in =>\n    // 4º mission requires 2 fails.\n    thisMissionRequires2fails = true;\n}\n\nif (msg.vNo == 0 ||\n    (thisMissionRequires2fails && msg.vNo == 1)) {\n    msg.mRes = 0;\n    node.warn(\"Mission won by resistance\");\n} \nelse {\n    msg.mRes = 1;\n    node.warn(\"Mission won by chunguitos\")\n}\ndelete msg.vYes; delete msg.vNo;\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":350,"y":700,"wires":[["6c23cda7.8caae4","537db9c1.cec818"]]},{"id":"5b800c91.d729d4","type":"function","z":"f3948f39.2753c","name":"Start next round","func":"let STATES = global.get(\"STATES\");\n\nnode.warn(\"Starting new round\");\n\nglobal.set(\"currentState\", STATES.ROUND);\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1543,"y":800,"wires":[[]]},{"id":"1fa84c75.0857b4","type":"sqlite","z":"f3948f39.2753c","mydb":"a5762d7.f21efd","sqlquery":"msg.topic","sql":"","name":"Delete failed team","x":1470,"y":660,"wires":[[]]},{"id":"2b68fa6f.2ab936","type":"function","z":"f3948f39.2753c","name":"Create template","func":"msg.topic = \"DELETE FROM MissionTeam WHERE mId = \" + (msg.currentMission.mId + 1); // +1 beacuse already - 1\nnode.warn(\"Deleting failed team:\\n\" +msg.topic);\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1280,"y":660,"wires":[["1fa84c75.0857b4"]]},{"id":"cda7d591.2942f8","type":"function","z":"f3948f39.2753c","name":"Create response for user device","func":"msg.payload = \"Done\";\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1850,"y":700,"wires":[["eb8d264.bf306d8"]]},{"id":"eb8d264.bf306d8","type":"http response","z":"f3948f39.2753c","name":"","x":2050,"y":700,"wires":[]},{"id":"74ec40a7.103b4","type":"function","z":"3ee4a50f.d7fd0a","name":"DEBUG SETUP","func":"msg = {};\nmsg.index = 0;\n\nlet STATES = global.get(\"STATES\");\nglobal.set(\"currentState\", STATES.ROUND);\nglobal.set(\"chunguitos\", [1, 2])\n\nmsg.queries = [\n    \"UPDATE Missions SET active = 0 WHERE mId = 1;\",\n    \"UPDATE Missions SET active = 1, leaderId = 4 WHERE mId = 4;\",\n    \"UPDATE Players SET pType = 1 WHERE pId = 1 OR pId = 2\"\n];\n\nlet result = [0, 0, 1];\nfor (let i = 1; i <= 3; i++) {\n    msg.queries.push(\"UPDATE Missions SET leaderId = \" + i +\n    \", mRes = \" + result[i - 1] + \n    \"  WHERE mId = \" + i);\n}\n\nfor (let i = 1; i <= 6; i++) {\n    msg.queries.push(\"UPDATE Players SET groupPos = \" + i + \" WHERE pId = \" + i);\n}\n\nlet vote = [[0, 0], [0, 0], [0, 1]];\nfor (let m = 1; m <= 3; m++) {\n    for (let p = 1; p <= 2; p++) {\n        msg.queries.push(\"INSERT INTO MissionTeam (pId, mId, vote) VALUES (\" + p + \", \" + m + \", \" + vote[m-1][p-1] + \")\");\n    }\n}\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1060,"y":220,"wires":[["efc23f60.49de9"]]},{"id":"efc23f60.49de9","type":"function","z":"3ee4a50f.d7fd0a","name":"from 1 to 5","func":"if (msg.index < msg.queries.length) {\n    msg.topic = msg.queries[msg.index++];\n    node.warn(msg.topic);\n    return msg;\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1230,"y":220,"wires":[["c7722cb8.f0cb7"]]},{"id":"c7722cb8.f0cb7","type":"sqlite","z":"3ee4a50f.d7fd0a","mydb":"a5762d7.f21efd","sqlquery":"msg.topic","sql":"","name":"Execute query","x":1400,"y":220,"wires":[["efc23f60.49de9"]]},{"id":"46f2b13.7b4465","type":"delay","z":"3ee4a50f.d7fd0a","name":"","pauseType":"delay","timeout":"3","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":850,"y":260,"wires":[["74ec40a7.103b4"]]},{"id":"8b3d6408.3667f8","type":"http in","z":"b081fd91.ebbbd","name":"","url":"/gameResult","method":"get","upload":false,"swaggerDoc":"","x":780,"y":560,"wires":[["2f55d4f1.cc3f3c"]]},{"id":"2f55d4f1.cc3f3c","type":"function","z":"b081fd91.ebbbd","name":"","func":"\nlet query = msg.req.query;\nquery.gameResult = global.get(\"gameResult\");\n\nlet str = [];\nfor (let k of Object.keys(query)) {\n    node.warn(k);\n    str.push(k+\"=\"+query[k]);\n}\n\nmsg.statusCode = 307; //Temporal redirect\nmsg.headers = {\n    Location: \"rootMenu?\"+str.join(\"&\")\n}\ndelete msg.payload;\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":990,"y":560,"wires":[["eb6dbd66.c12b3"]]},{"id":"eb6dbd66.c12b3","type":"http response","z":"b081fd91.ebbbd","name":"","x":1220,"y":560,"wires":[]},{"id":"9239a0df.c8071","type":"http in","z":"b081fd91.ebbbd","name":"","url":"/gameOver","method":"get","upload":false,"swaggerDoc":"","x":120,"y":480,"wires":[["c642507a.3c528"]]},{"id":"c642507a.3c528","type":"function","z":"b081fd91.ebbbd","name":"gameOver","func":"if (msg.req.query.gameResult) { // If gameResult addressed\n    msg.NAME = \"gameOver\";\n    return [msg, null];\n}\nelse { // GameResult NOT addressed, get it\n    let query = msg.req.query;\n    // Get gameResult for the player\n\n    let gameResult = global.get(\"gameResult\");\n    let amIchunguito = 0;\n    for (let n of global.get(\"chunguitos\")) {\n        if (n == query.pId) { // If user is a chunguito\n            amIchunguito = 2;\n            break;\n        }\n    }\n\n    query.gameResult = gameResult + amIchunguito;\n    \n    let str = [];\n    for (let k of Object.keys(query)) {\n        str.push(k+\"=\"+query[k]);\n    }\n    \n    //Redirect the user to the endGame with the gameResult\n    msg.statusCode = 307; //Temporal redirect\n    msg.headers = {\n        Location: \"gameOver?\"+str.join(\"&\") // Same url with all the params\n    }\n    delete msg.payload;\n    return [null, msg];\n}","outputs":2,"noerr":0,"initialize":"","finalize":"","libs":[],"x":290,"y":480,"wires":[["ea1ce062.d9564"],["52578a16.4c10b4"]]},{"id":"52578a16.4c10b4","type":"http response","z":"b081fd91.ebbbd","name":"","x":470,"y":480,"wires":[]},{"id":"a78fcd1.fb22e3","type":"sqlite","z":"f3948f39.2753c","mydb":"a5762d7.f21efd","sqlquery":"fixed","sql":"SELECT * FROM Missions;","name":"Get missions","x":1270,"y":760,"wires":[["7f16269b.a92298"]]},{"id":"3a8e7726.d98b68","type":"function","z":"f3948f39.2753c","name":"Go to gameOver","func":"msg.payload = \"gameOver\";\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":810,"y":1040,"wires":[["a53863af.9150a"]]},{"id":"17ca7d86.407272","type":"inject","z":"3ee4a50f.d7fd0a","name":"debugTrigger","props":[{"p":"payload"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":790,"y":1340,"wires":[["ee3cc2c.020324"]]},{"id":"ee3cc2c.020324","type":"function","z":"3ee4a50f.d7fd0a","name":"","func":"node.warn(global.get(\"gameResult\"));\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":950,"y":1340,"wires":[[]]}]